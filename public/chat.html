<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>Chat</title>

Â  Â  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDQ6REQWS8"></script>
Â  <script>
Â  Â  window.dataLayer = window.dataLayer || [];
Â  Â  function gtag(){dataLayer.push(arguments);}
Â  Â  gtag('js', new Date());
Â  Â  gtag('config', 'G-FDQ6REQWS8');
Â  </script>

Â  <link rel="stylesheet" href="style.css" />
Â  <style>
Â  body {
Â  Â  margin: 0;
Â  Â  font-family: Arial, sans-serif;
Â  Â  background: linear-gradient(#ffcccc, #ffe6e6);
Â  Â  height: 100vh;
Â  Â  display: flex;
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  overflow: hidden;
Â  }

Â  .chat-container {
Â  Â  width: 400px;
Â  Â  height: 90vh;
Â  Â  background: #fff;
Â  Â  border-radius: 10px;
Â  Â  box-shadow: 0 0 10px rgba(0,0,0,0.2);
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  overflow: hidden;
Â  }

Â  .chat-header {
Â  Â  background: #ff4d6d;
Â  Â  color: #fff;
Â  Â  padding: 15px;
Â  Â  font-weight: bold;
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  gap: 10px;
Â  }
Â  .chat-header img {
Â  Â  width: 40px;
Â  Â  height: 40px;
Â  Â  border-radius: 50%;
Â  Â  object-fit: cover;
Â  }

Â  .gift-bar {
Â  Â  background: #fff6f9;
Â  Â  padding: 8px;
Â  Â  text-align: center;
Â  Â  border-bottom: 1px solid #ffd6e0;
Â  }
Â  .gift-bar p {
Â  Â  margin: 4px 0;
Â  Â  font-size: 14px;
Â  Â  color: #555;
Â  }

Â  /* gifts row */
Â  .gift-bar .row{
Â  Â  display:flex !important;
Â  Â  flex-direction:row !important;
Â  Â  flex-wrap:wrap;
Â  Â  justify-content:center;
Â  Â  align-items:center;
Â  Â  gap:10px;
Â  Â  margin-top:6px;
Â  }
Â  .gift-chip{
Â  Â  display:inline-flex;
Â  Â  align-items:center;
Â  Â  justify-content:center;
Â  Â  width:36px; height:36px;
Â  Â  border-radius:999px;
Â  Â  background:#fff;
Â  Â  border:1px solid #ffd1dc;
Â  Â  font-size:18px;
Â  Â  cursor:pointer;
Â  Â  transition:transform .08s ease;
Â  Â  line-height:1;
Â  }
Â  .gift-chip:hover{ transform: translateY(-1px); }

Â  .gifts { display: flex; justify-content: center; gap: 10px; }
Â  .gift-btn { background: none; border: none; font-size: 24px; cursor: pointer; }
Â  .gift-btn:hover { transform: scale(1.2); }

Â  .chat-box {
Â  Â  flex: 1;
Â  Â  overflow-y: auto;
Â  Â  padding: 10px;
Â  Â  background: #fff0f5;
Â  Â  min-height: 0;
Â  }

Â  .message {
Â  Â  margin: 8px 0;
Â  Â  padding: 10px;
Â  Â  border-radius: 8px;
Â  Â  max-width: 75%;
Â  Â  word-wrap: break-word;
Â  }
Â  .message.user { background: #d1e7dd; margin-left: auto; }
Â  .message.girl { background: #ffe6eb; margin-right: auto; }

Â  .message.premium {
Â  Â  background: #fff3cd;
Â  Â  border: 1px solid #ffeeba;
Â  Â  color: #856404;
Â  Â  font-size: 14px;
Â  Â  text-align: center;
Â  Â  margin: 10px auto;
Â  Â  max-width: 90%;
Â  }

Â  .chat-input {
Â  Â  display: flex;
Â  Â  padding: 10px;
Â  Â  background: #fff;
Â  Â  border-top: 1px solid #ddd;
Â  }
Â  .chat-input textarea,
Â  .chat-input input[type="text"]{
Â  Â  flex: 1;
Â  Â  resize: none;
Â  Â  padding: 10px;
Â  Â  border-radius: 5px;
Â  Â  border: 1px solid #ccc;
Â  Â  font-size: 14px;
Â  }
Â  .chat-input button {
Â  Â  background: #ff4d6d;
Â  Â  border: none;
Â  Â  color: #fff;
Â  Â  padding: 10px 15px;
Â  Â  margin-left: 8px;
Â  Â  border-radius: 5px;
Â  Â  cursor: pointer;
Â  }
Â  .chat-input button:hover { background: #e63b5e; }

Â  .cta-bar {
Â  Â  display: block;
Â  Â  border-top: 1px solid #ffd1dc;
Â  Â  background: #fff5f7;
Â  Â  padding: 10px;
Â  Â  text-align: center;
Â  Â  flex-shrink: 0;
Â  }
Â  .cta-bar a.cta-link{
Â  Â  display:inline-block;
Â  Â  background:#ef476f;
Â  Â  color:#fff !important;
Â  Â  padding:8px 12px;
Â  Â  border-radius:8px;
Â  Â  text-decoration:none !important;
Â  Â  font-weight:bold;
Â  }
Â  .cta-bar a.cta-link:hover{ filter:brightness(0.95); }

Â  .upgrade-btn { background: #ff4d6d; border: none; color: #fff; padding: 12px; font-size: 16px; cursor: pointer; border-radius: 0 0 10px 10px; text-align: center; }
Â  .upgrade-btn:hover { background: #e63b5e; }

Â  /* neutral â€œsystem noticeâ€ */
Â  .system-card{
Â  Â  background:#ffffff;
Â  Â  border:1px solid #ffd1dc;
Â  Â  border-radius:12px;
Â  Â  padding:12px;
Â  Â  margin:10px auto;
Â  Â  text-align:center;
Â  Â  max-width:90%;
Â  Â  color:#444;
Â  Â  box-shadow:0 2px 6px rgba(0,0,0,.04);
Â  }
Â  .system-card img{ max-width:64px; height:auto; display:block; margin:0 auto 6px; }
Â  .system-card .title{ font-weight:700; color:#d81b60; margin-bottom:6px; }
Â  .system-card p{ margin:0; line-height:1.35; font-size:14px; }

Â  /* image + lock overlay */
Â  .image-wrap{ position: relative; display: inline-block; border-radius: 10px; overflow: hidden; }
Â  .image-wrap img{ display:block; max-width: 220px; max-height: 260px; border-radius: 10px; object-fit: cover; }
Â  .image-wrap.locked img{ filter: blur(10px); }
Â  .image-overlay{
Â  Â  position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
Â  Â  text-align:center; padding:10px; background: rgba(0,0,0,0.45); color:#fff; font-size:13px; gap:8px;
Â  }
Â  .image-overlay a{ display:inline-block; background:#ef476f; color:#fff; text-decoration:none; padding:8px 10px; border-radius:8px; font-weight:bold; }

Â  /* promo modal */
Â  .promo-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:10000;align-items:center;justify-content:center}
Â  .promo-card{width:min(520px,92vw);background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden;border:1px solid #ffd1dc}
Â  .promo-head{background:#ff4d6d;color:#fff;padding:14px 16px;font-weight:bold}
Â  .promo-body{padding:16px}
Â  .promo-title{font-size:18px;font-weight:800;margin:0 0 6px}
Â  .promo-sub{color:#555;margin:0 0 10px;line-height:1.35}
Â  .promo-list{margin:0 0 12px 16px;padding:0;color:#444}
Â  .promo-list li{margin:4px 0}
Â  .promo-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
Â  .btn{padding:10px 12px;border-radius:10px;border:1px solid #ffd1dc;background:#fff;cursor:pointer}
Â  .btn.primary{background:#ef476f;color:#fff;border:none}
Â  .btn.ghost{background:#fff;color:#111;border:1px solid #e6e6e6}
Â  .promo-questions .q{margin:12px 0}
Â  .promo-questions label{display:block;font-weight:600;margin-bottom:6px}
Â  .chips{display:flex;flex-wrap:wrap;gap:8px}
Â  .chips label{cursor:pointer}
Â  .chips input{display:none}
Â  .chips .chip{border:1px solid #e6e6e6;border-radius:999px;padding:8px 12px}
Â  .chips input:checked + .chip{border-color:#ef476f;background:#fff5f7}
Â  .progress{height:8px;background:#f1f1f1;border-radius:999px;overflow:hidden}
Â  .progress>div{height:100%;width:0;background:#ef476f;transition:width .2s}
Â  </style>

Â  <script type="text/javascript" src="https://api.goaffpro.com/loader.js?shop=nzyvwvfbde"></script>
</head>
<body>
Â  <div class="chat-container">
Â  Â  <div class="chat-header">
Â  Â  Â  <img id="chatPhoto" src="" alt="Girl Photo">
Â  Â  Â  <h2 id="chatName"></h2>
Â  Â  </div>

Â  Â  Â  Â  <div id="giftBar" class="gift-bar">
Â  Â  Â  <div style="margin-bottom:6px;">Send <strong id="giftGirlName">her</strong> a gift:</div>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="gift-chip" data-gift="flowers" title="Flowers">ğŸ’</div>
Â  Â  Â  Â  <div class="gift-chip" data-gift="ring" title="Ring">ğŸ’</div>
Â  Â  Â  Â  <div class="gift-chip" data-gift="candy" title="Chocolate">ğŸ«</div>
Â  Â  Â  Â  <div class="gift-chip" data-gift="puppy" title="Puppy">ğŸ¶</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="liveBanner" style="display:none"></div>

Â  Â  <div class="chat-box" id="chatBox"></div>

Â  Â  Â  Â  <div id="ctaBar" class="cta-bar">
Â  Â  Â  <a class="cta-link" href="https://charmr.xyz/checkout.html">GET PREMIUM NOW!</a>
Â  Â  </div>

Â  Â  <div class="chat-input">
Â  Â  Â  <input type="text" id="messageInput" placeholder="Type a message...">
Â  Â  Â  <button onclick="sendMessage()">Send</button>
Â  Â  Â  <button id="sendPhotoBtn" type="button">Send photo</button>
Â  Â  Â  <input id="photoInput" type="file" accept="image/*" style="display:none" />
Â  Â  </div>
Â  </div>

Â  Â  <div id="promoBackdrop" class="promo-backdrop" aria-hidden="true">
Â  Â  <div class="promo-card" role="dialog" aria-modal="true" aria-labelledby="promoTitle">
Â  Â  Â  <div class="promo-head">Charmr Premium Invitation</div>

Â  Â  Â  <div id="promoStepIntro" class="promo-body">
Â  Â  Â  Â  <h3 id="promoTitle" class="promo-title">CONGRATULATIONS! You have been selected for a chance to try Charmr for FREE!</h3>
Â  Â  Â  Â  <p class="promo-sub">
Â  Â  Â  Â  Â  Get <strong>unlimited messages</strong>, <strong>unlimited sending and receiving of images</strong>,
Â  Â  Â  Â  Â  <strong>contact and social media sharing</strong>, <strong>gift sending</strong> and more.<br>
Â  Â  Â  Â  Â  <strong>Value Â£99</strong> â€” <strong>your price: FREE</strong>.
Â  Â  Â  Â  </p>
Â  Â  Â  Â  <p class="promo-sub"><em>But first, answer a few questions to see if you qualify.</em></p>
Â  Â  Â  Â  <div class="promo-actions">
Â  Â  Â  Â  Â  <button id="promoStart" class="btn primary">Start</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div id="promoQ1" class="promo-body" style="display:none">
Â  Â  Â  Â  <div class="promo-questions">
Â  Â  Â  Â  Â  <div class="q">
Â  Â  Â  Â  Â  Â  <label>Are you a man or a woman?</label>
Â  Â  Â  Â  Â  Â  <div class="chips">
Â  Â  Â  Â  Â  Â  Â  <label><input type="radio" name="q_gender" value="man"><span class="chip">Man</span></label>
Â  Â  Â  Â  Â  Â  Â  <label><input type="radio" name="q_gender" value="woman"><span class="chip">Woman</span></label>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div id="promoQ2" class="promo-body" style="display:none">
Â  Â  Â  Â  <div class="promo-questions">
Â  Â  Â  Â  Â  <div class="q">
Â  Â  Â  Â  Â  Â  <label>Are you over 40 years of age?</label>
Â  Â  Â  Â  Â  Â  <div class="chips">
Â  Â  Â  Â  Â  Â  Â  <label><input type="radio" name="q_over40" value="yes"><span class="chip">Yes</span></label>
Â  Â  Â  Â  Â  Â  Â  <label><input type="radio" name="q_over40" value="no"><span class="chip">No</span></label>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div id="promoQ3" class="promo-body" style="display:none">
Â  Â  Â  Â  <div class="promo-questions">
Â  Â  Â  Â  Â  <div class="q">
Â  Â  Â  Â  Â  Â  <label>Do you have a job?</label>
Â  Â  Â  Â  Â  Â  <div class="chips">
Â  Â  Â  Â  Â  Â  Â  <label><input type="radio" name="q_job" value="yes"><span class="chip">Yes</span></label>
Â  Â  Â  Â  Â  Â  Â  <label><input type="radio" name="q_job" value="no"><span class="chip">No</span></label>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div id="promoQ4" class="promo-body" style="display:none">
Â  Â  Â  Â  <div class="promo-questions">
Â  Â  Â  Â  Â  <div class="q">
Â  Â  Â  Â  Â  Â  <label>What are you looking for on Charmr?</label>
Â  Â  Â  Â  Â  Â  <div class="chips">
Â  Â  Â  Â  Â  Â  Â  <label><input type="radio" name="q_goal" value="sex"><span class="chip">Sex</span></label>
Â  Â  Â  Â  Â  Â  Â  <label><input type="radio" name="q_goal" value="love"><span class="chip">Love</span></label>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div id="promoStepLoading" class="promo-body" style="display:none">
Â  Â  Â  Â  <p class="promo-sub">Processing answersâ€¦</p>
Â  Â  Â  Â  <div class="progress"><div id="promoProgress"></div></div>
Â  Â  Â  </div>

Â  Â  Â  <div id="promoStepDone" class="promo-body" style="display:none">
Â  Â  Â  Â  <h3 class="promo-title">CONGRATULATIONS! You've qualified to try the premium features of Charmr for FREE!</h3>
Â  Â  Â  Â  <ul class="promo-list">
Â  Â  Â  Â  Â  <li>Unlimited messages</li>
Â  Â  Â  Â  Â  <li>Unlimited sending and receiving of images</li>
Â  Â  Â  Â  Â  <li>Contact and social media sharing</li>
Â  Â  Â  Â  Â  <li>Gift sending and more</li>
Â  Â  Â  Â  </ul>
Â  Â  Â  Â  <p class="promo-sub"><strong>Value Â£99</strong> â€” <strong>your price: FREE</strong>.</p>
Â  Â  Â  Â  <p class="promo-sub">
Â  Â  Â  Â  Â  In order to make sure everyone on this site is 18+ we use Visa, Mastercard and the Age Verification Providers
Â  Â  Â  Â  Â  Association to verify your age using your Visa or Mastercard on the next page. This works because banks only
Â  Â  Â  Â  Â  issue credit cards to people over 18, so itâ€™s a fast way to keep our community adult-only.
Â  Â  Â  Â  </p>
Â  Â  Â  Â  <div class="promo-actions">
Â  Â  Â  Â  Â  <a class="btn primary" href="https://www.charmr.xyz/verification.html">VERIFY MY AGE</a>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <script src="girls.js"></script>
Â  <script>
Â  Â  // MODIFIED: Changed backendUrl to local host for testing your uploaded server file
Â  Â  const backendUrl = "http://localhost:10000";
Â  Â  const token = localStorage.getItem("token");
Â  Â  if (!token) { window.location.href = "login.html"; }

Â  Â  const params = new URLSearchParams(window.location.search);
Â  Â  const girlId = parseInt(params.get('id'));
Â  Â  const chatBox = document.getElementById('chatBox');
Â  Â  const ctaBarÂ  = document.getElementById('ctaBar');

Â  Â  // header (with server fallback)
Â  Â  async function setHeader(){
Â  Â  Â  const nameEl = document.getElementById('chatName');
Â  Â  Â  const photoEl = document.getElementById('chatPhoto');

Â  Â  Â  let g = (typeof girls !== 'undefined' && Array.isArray(girls))
Â  Â  Â  Â  Â  Â  Â ? girls.find(x => Number(x.id) === Number(girlId))
Â  Â  Â  Â  Â  Â  Â : null;

Â  Â  Â  if (!g) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const r = await fetch(`${backendUrl}/api/profiles`);
Â  Â  Â  Â  Â  const list = await r.json();
Â  Â  Â  Â  Â  g = Array.isArray(list) ? list.find(x => Number(x.id) === Number(girlId)) : null; // /api/profiles
Â  Â  Â  Â  } catch {}
Â  Â  Â  }

Â  Â  Â  nameEl.textContent = g?.name || 'Unknown';
Â  Â  Â  document.getElementById('giftGirlName').textContent = (g?.name || 'her').split(' ')[0];

Â  Â  Â  photoEl.src = g?.image || 'default-avatar.png';
Â  Â  Â  photoEl.onerror = () => { photoEl.onerror = null; photoEl.src = 'default-avatar.png'; };
Â  Â  }

Â  Â  // state
Â  Â  let TAKEOVER = false;
Â  Â  let pollTimer = null;

Â  Â  // entitlements
Â  Â  let ENTITLEMENTS = {
Â  Â  Â  tier: "free",
Â  Â  Â  status: "inactive",
Â  Â  Â  canSendGifts: false,
Â  Â  Â  canSendImages: false,
Â  Â  Â  maxReceivedImagesUnblurred: 2,
Â  Â  Â  canShareContacts: false
Â  Â  };
Â  Â  let IS_PREMIUM = false;
Â  Â  let MSGS_TIMER = null;

Â  Â  // received images gating
Â  Â  let RECEIVED_GIRL_IMAGE_COUNT = 0;
Â  Â  let FREE_IMAGE_LIMIT = 2;

Â  Â  // promo trigger
Â  Â  let PREMIUM_BLOCK_COUNT = 0;
Â  Â  let PROMO_TIMER = null;
Â  Â  let PROMO_SHOWN = false;

Â  Â  // persistent notices
Â  Â  const LOCAL_NOTICES = []; // { text, index }
Â  Â  function appendPersistentNotice(text){
Â  Â  Â  const indexAtInsert = chatBox.children.length;
Â  Â  Â  appendSystemNotice(text);
Â  Â  Â  LOCAL_NOTICES.push({ text, index: indexAtInsert });
Â  Â  }

Â  Â  function recordPremiumBlock(){
Â  Â  Â  if (PROMO_SHOWN) return;
Â  Â  Â  PREMIUM_BLOCK_COUNT++;
Â  Â  Â  if (PREMIUM_BLOCK_COUNT >= 2){
Â  Â  Â  Â  if (PROMO_TIMER) clearTimeout(PROMO_TIMER);
Â  Â  Â  Â  PROMO_TIMER = setTimeout(()=>{ openPromoIntro(); }, 15000);
Â  Â  Â  }
Â  Â  }

Â  Â  function showCTA(){ ctaBar.style.display = 'block'; }
Â  Â  function hideCTA(){ ctaBar.style.display = 'none'; }

Â  Â  function ensureMessagesPolling(){
Â  Â  Â  if (TAKEOVER){
Â  Â  Â  Â  if (MSGS_TIMER){ clearInterval(MSGS_TIMER); MSGS_TIMER = null; }
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  if (!MSGS_TIMER){
Â  Â  Â  Â  MSGS_TIMER = setInterval(loadMessages, 2000);
Â  Â  Â  }
Â  Â  }

Â  Â  function appendMessage(text, sender, isTyping=false){
Â  Â  Â  const msgDiv = document.createElement('div');
Â  Â  Â  msgDiv.className = `message ${sender}`;

Â  Â  Â  if (isTyping){
Â  Â  Â  Â  msgDiv.classList.add('typing');
Â  Â  Â  Â  msgDiv.textContent = '...';
Â  Â  Â  } else {
Â  Â  Â  Â  // Gift render: GIFT:<type>
Â  Â  Â  Â  const g = /^GIFT:\s*(flowers|ring|chocolate|puppy)\b/i.exec(text || "");
Â  Â  Â  Â  if (g){
Â  Â  Â  Â  Â  const name = g[1].toLowerCase();
Â  Â  Â  Â  Â  const wrap = document.createElement('div');
Â  Â  Â  Â  Â  wrap.className = 'image-wrap';
Â  Â  Â  Â  Â  const img = document.createElement('img');
Â  Â  Â  Â  Â  img.src = `/images/${name}.png`;
Â  Â  Â  Â  Â  img.alt = `${name} gift`;
Â  Â  Â  Â  Â  wrap.appendChild(img);
Â  Â  Â  Â  Â  msgDiv.appendChild(wrap);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // Image render: IMAGE:<url> or <img src="..."> or bare .png/.jpg URL
Â  Â  Â  Â  Â  const m = /IMAGE:\s*([^\s<>"']+)/i.exec(text || "");
Â  Â  Â  Â  Â  const tag = !m ? /<img[^>]*src=["']([^"']+)["'][^>]*>/i.exec(text || "") : null;
Â  Â  Â  Â  Â  const urlOnly = (!m && !tag) ? /(https?:\/\/[^\s"'()]+?\.(?:png|jpe?g|gif|webp))(?:[^\s"')]*)?/i.exec(text || "") : null;

Â  Â  Â  Â  Â  if (m || tag || urlOnly){
Â  Â  Â  Â  Â  Â  const url = m ? m[1] : (tag ? tag[1] : urlOnly[1]);
Â  Â  Â  Â  Â  Â  const wrap = document.createElement('div');
Â  Â  Â  Â  Â  Â  wrap.className = 'image-wrap';

Â  Â  Â  Â  Â  Â  const img = document.createElement('img');
Â  Â  Â  Â  Â  Â  img.src = url;
Â  Â  Â  Â  Â  Â  img.alt = 'image';
Â  Â  Â  Â  Â  Â  img.loading = 'eager';
Â  Â  Â  Â  Â  Â  img.decoding = 'sync';
Â  Â  Â  Â  Â  Â  img.referrerPolicy = 'no-referrer';
Â  Â  Â  Â  Â  Â  wrap.appendChild(img);

Â  Â  Â  Â  Â  Â  if (sender === 'girl') {
Â  Â  Â  Â  Â  Â  Â  RECEIVED_GIRL_IMAGE_COUNT += 1;
Â  Â  Â  Â  Â  Â  Â  const limit = ENTITLEMENTS.maxReceivedImagesUnblurred ?? FREE_IMAGE_LIMIT;
Â  Â  Â  Â  Â  Â  Â  const isBlur = !(ENTITLEMENTS.canSendImages) && RECEIVED_GIRL_IMAGE_COUNT > limit;
Â  Â  Â  Â  Â  Â  Â  if (isBlur) {
Â  Â  Â  Â  Â  Â  Â  Â  wrap.classList.add('locked');
Â  Â  Â  Â  Â  Â  Â  Â  const overlay = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  overlay.className = 'image-overlay';
Â  Â  Â  Â  Â  Â  Â  Â  overlay.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>You've received the maximum amount of pictures on your current plan.</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="https://charmr.xyz/checkout.html">Upgrade to Premium</a>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  wrap.appendChild(overlay);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  msgDiv.appendChild(wrap);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  msgDiv.textContent = text;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  chatBox.appendChild(msgDiv);

Â  Â  Â  const im = msgDiv.querySelector('img');
Â  Â  Â  if (im) {
Â  Â  Â  Â  if (im.complete) {
Â  Â  Â  Â  Â  chatBox.scrollTop = chatBox.scrollHeight;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  im.addEventListener('load', () => { chatBox.scrollTop = chatBox.scrollHeight; }, { once: true });
Â  Â  Â  Â  Â  im.addEventListener('error', () => {}, { once: true });
Â  Â  Â  Â  }
Â  Â  Â  } else {
Â  Â  Â  Â  chatBox.scrollTop = chatBox.scrollHeight;
Â  Â  Â  }

Â  Â  Â  return msgDiv;
Â  Â  }

Â  Â  function appendSystemNotice(text){
Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  card.className = 'system-card';
Â  Â  Â  const logo = document.createElement('img');
Â  Â  Â  logo.src = 'logo.png';
Â  Â  Â  logo.alt = 'Site logo';
Â  Â  Â  const title = document.createElement('div');
Â  Â  Â  title.className = 'title';
Â  Â  Â  title.textContent = 'Premium Feature';
Â  Â  Â  const p = document.createElement('p');
Â  Â  Â  p.textContent = text;
Â  Â  Â  card.appendChild(logo);
Â  Â  Â  card.appendChild(title);
Â  Â  Â  card.appendChild(p);
Â  Â  Â  chatBox.appendChild(card);
Â  Â  Â  chatBox.scrollTop = chatBox.scrollHeight;
Â  Â  Â  return card;
Â  Â  }

Â  Â  function randomDelay(min=700, max=2000){ return Math.floor(Math.random()*(max-min+1))+min; }

Â  Â  // detect phone/email/links/handles/WhatsApp etc.
Â  Â  function isContactAttempt(text) {
Â  Â  Â  if (!text) return false;
Â  Â  Â  const patterns = [
Â  Â  Â  Â  /@/i,
Â  Â  Â  Â  /\b(whats?app|telegram|snap(chat)?|instagram|insta|tg|wechat|signal|viber)\b/i,
Â  Â  Â  Â  /\b(phone|number|call|text|dm|pm)\b/i,
Â  Â  Â  Â  /https?:\/\/|www\./i,
Â  Â  Â  Â  /\b\d{3}[-.\s]?\d{3}[-.\s]?\d{4}\b/,
Â  Â  Â  Â  /\b\+?\d{1,3}[-.\s]?\d{6,14}\b/
Â  Â  Â  ];
Â  Â  Â  return patterns.some(re => re.test(text));
Â  Â  }

Â  Â  async function loadMessages(){
Â  Â  Â  try{
Â  Â  Â  Â  const res = await fetch(`${backendUrl}/api/messages/${girlId}`, {
Â  Â  Â  Â  Â  headers: { "Authorization": `Bearer ${token}` }
Â  Â  Â  Â  });
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  chatBox.innerHTML = "";

Â  Â  Â  Â  RECEIVED_GIRL_IMAGE_COUNT = 0;

Â  Â  Â  Â  data.forEach(msg => appendMessage(msg.text, msg.from_user ? "user" : "girl"));

Â  Â  Â  Â  if (LOCAL_NOTICES.length){
Â  Â  Â  Â  Â  const sorted = [...LOCAL_NOTICES].sort((a,b)=>a.index-b.index);
Â  Â  Â  Â  Â  for (const n of sorted){
Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  card.className = 'system-card';
Â  Â  Â  Â  Â  Â  const logo = document.createElement('img');
Â  Â  Â  Â  Â  Â  logo.src = 'logo.png';
Â  Â  Â  Â  Â  Â  logo.alt = 'Site logo';
Â  Â  Â  Â  Â  Â  const title = document.createElement('div');
Â  Â  Â  Â  Â  Â  title.className = 'title';
Â  Â  Â  Â  Â  Â  title.textContent = 'Premium Feature';
Â  Â  Â  Â  Â  Â  const p = document.createElement('p');
Â  Â  Â  Â  Â  Â  p.textContent = n.text;
Â  Â  Â  Â  Â  Â  card.appendChild(logo); card.appendChild(title); card.appendChild(p);

Â  Â  Â  Â  Â  Â  const beforeChild = chatBox.children[n.index] || null;
Â  Â  Â  Â  Â  Â  chatBox.insertBefore(card, beforeChild);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  chatBox.scrollTop = chatBox.scrollHeight;
Â  Â  Â  Â  }

Â  Â  Â  Â  showCTA();
Â  Â  Â  }catch(e){ console.error("Error loading messages:", e); }
Â  Â  }

Â  Â  async function checkTakeover(){
Â  Â  Â  try{
Â  Â  Â  Â  const res = await fetch(`${backendUrl}/api/takeover/status/${girlId}`, {
Â  Â  Â  Â  Â  headers: { "Authorization": `Bearer ${token}` }
Â  Â  Â  Â  });
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  TAKEOVER = !!data.takeover;
Â  Â  Â  Â  const banner = document.getElementById('liveBanner');
Â  Â  Â  Â  if (TAKEOVER){
Â  Â  Â  Â  Â  banner.style.display = '';
Â  Â  Â  Â  Â  banner.textContent = data.operatorName ? `ğŸ”´ ${data.operatorName} is live` : '';
Â  Â  Â  Â  Â  if (!pollTimer) pollTimer = setInterval(loadMessages, 2000);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  banner.style.display = 'none';
Â  Â  Â  Â  Â  if (pollTimer){ clearInterval(pollTimer); pollTimer = null; }
Â  Â  Â  Â  }
Â  Â  Â  Â  ensureMessagesPolling();
Â  Â  Â  }catch{
Â  Â  Â  Â  ensureMessagesPolling();
Â  Â  Â  }
Â  Â  }

Â  Â  async function refreshEntitlements(){
Â  Â  Â  try{
Â  Â  Â  Â  const r = await fetch(`${backendUrl}/api/me/entitlements`, {
Â  Â  Â  Â  Â  headers: { "Authorization": `Bearer ${token}` }
Â  Â  Â  Â  });
Â  Â  Â  Â  if (r.ok){
Â  Â  Â  Â  Â  const e = await r.json();
Â  Â  Â  Â  Â  ENTITLEMENTS = {
Â  Â  Â  Â  Â  Â  tier: e.tier || ENTITLEMENTS.tier,
Â  Â  Â  Â  Â  Â  status: e.status || ENTITLEMENTS.status,
Â  Â  Â  Â  Â  Â  canSendGifts: !!e.canSendGifts,
Â  Â  Â  Â  Â  Â  canSendImages: !!e.canSendImages,
Â  Â  Â  Â  Â  Â  maxReceivedImagesUnblurred: Number.isFinite(e.maxReceivedImagesUnblurred) ? e.maxReceivedImagesUnblurred : ENTITLEMENTS.maxReceivedImagesUnblurred,
Â  Â  Â  Â  Â  Â  canShareContacts: !!e.canShareContacts
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  IS_PREMIUM = ENTITLEMENTS.canSendImages || ENTITLEMENTS.canShareContacts || ENTITLEMENTS.canSendGifts;
Â  Â  Â  Â  Â  FREE_IMAGE_LIMIT = ENTITLEMENTS.maxReceivedImagesUnblurred ?? 2;
Â  Â  Â  Â  Â  showCTA();
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  }catch{}

Â  Â  Â  // fallback to legacy credits
Â  Â  Â  try{
Â  Â  Â  Â  const r = await fetch(`${backendUrl}/api/credits`, {
Â  Â  Â  Â  Â  headers: { "Authorization": `Bearer ${token}` }
Â  Â  Â  Â  });
Â  Â  Â  Â  if (r.ok){
Â  Â  Â  Â  Â  const c = await r.json();
Â  Â  Â  Â  Â  IS_PREMIUM = !!c?.lifetime;
Â  Â  Â  Â  Â  ENTITLEMENTS.canSendImages = IS_PREMIUM;
Â  Â  Â  Â  Â  ENTITLEMENTS.canSendGifts = IS_PREMIUM;
Â  Â  Â  Â  Â  ENTITLEMENTS.canShareContacts = IS_PREMIUM;
Â  Â  Â  Â  Â  ENTITLEMENTS.maxReceivedImagesUnblurred = IS_PREMIUM ? 9999 : 2;
Â  Â  Â  Â  Â  FREE_IMAGE_LIMIT = ENTITLEMENTS.maxReceivedImagesUnblurred;
Â  Â  Â  Â  }
Â  Â  Â  }catch{}
Â  Â  }

Â  Â  async function sendMessage(){
Â  Â  Â  const input = document.getElementById('messageInput');
Â  Â  Â  const messageText = input.value.trim();
Â  Â  Â  if (!messageText) return;

Â  Â  Â  // contact gating
Â  Â  Â  if (isContactAttempt(messageText)) {
Â  Â  Â  Â  if (!ENTITLEMENTS.canShareContacts) {
Â  Â  Â  Â  Â  appendPersistentNotice(
Â  Â  Â  Â  Â  Â  "Sharing numbers, WhatsApp, emails or links is a Premium feature (included in the Â£20/mo plan and VIP). Tap the pink button below to upgrade."
Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  showCTA();
Â  Â  Â  Â  Â  recordPremiumBlock();
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  appendMessage(messageText, 'user');
Â  Â  Â  Â  Â  input.value = '';
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await fetch(`${backendUrl}/api/contacts/share`, {
Â  Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  Â  headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ girlId, contactText: messageText })
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  } catch(e) { console.error("Contact share failed:", e); }
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  appendMessage(messageText, 'user');
Â  Â  Â  input.value = '';
Â  Â  Â  const typingBubble = appendMessage("...", 'girl', true);

Â  Â  Â  try{
Â  Â  Â  Â  const res = await fetch(`${backendUrl}/api/chat`, {
Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
Â  Â  Â  Â  Â  body: JSON.stringify({ girlId, message: messageText })
Â  Â  Â  Â  });

Â  Â  Â  Â  if (res.status === 403){
Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  typingBubble.remove();
Â  Â  Â  Â  Â  appendMessage(data.error || "You're out of credits!", 'girl');
Â  Â  Â  Â  Â  showCTA();
Â  Â  Â  Â  Â  chatBox.scrollTop = chatBox.scrollHeight;
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  await new Promise(r => setTimeout(r, randomDelay()));
Â  Â  Â  Â  typingBubble.remove();

Â  Â  Â  Â  if (data.takeover){
Â  Â  Â  Â  Â  TAKEOVER = true;
Â  Â  Â  Â  Â  checkTakeover();
Â  Â  Â  Â  Â  appendMessage("â€¦", "girl", true);
Â  Â  Â  Â  Â  if (!pollTimer) pollTimer = setInterval(loadMessages, 2000);
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  appendMessage(data.reply || "(No reply received)", 'girl');
Â  Â  Â  Â  refreshEntitlements();
Â  Â  Â  }catch(e){
Â  Â  Â  Â  console.error("Chat error:", e);
Â  Â  Â  Â  typingBubble.remove();
Â  Â  Â  }
Â  Â  }

Â  Â  // gift prices
Â  Â  const GIFT_PRICES_GBP = { chocolate: 5, flowers: 15, puppy: 25, ring: 99 };

Â  Â  document.getElementById('giftBar').addEventListener('click', async (e)=>{
Â  Â  Â  const chip = e.target.closest('.gift-chip');
Â  Â  Â  if (!chip) return;

Â  Â  Â  if (!ENTITLEMENTS.canSendGifts){
Â  Â  Â  Â  const labelBlocked = (chip.getAttribute('title') || 'gift').toLowerCase();
Â  Â  Â  Â  appendPersistentNotice(
Â  Â  Â  Â  Â  `Sending ${labelBlocked} is a Premium feature. Upgrade using the pink button at the bottom to unlock gifts & pics.`
Â  Â  Â  Â  );
Â  Â  Â  Â  showCTA();
Â  Â  Â  Â  recordPremiumBlock();
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  let type = (chip.dataset.gift || '').toLowerCase();
Â  Â  Â  if (type === 'candy') type = 'chocolate';
Â  Â  Â  const label = (chip.getAttribute('title') || type).toLowerCase();
Â  Â  Â  const price = GIFT_PRICES_GBP[type];
Â  Â  Â  if (!price) { console.warn('Unknown gift type:', type); return; }

Â  Â  Â  const ok = confirm(`Send ${label} for Â£${price}?`);
Â  Â  Â  if (!ok) return;

Â  Â  Â  try{
Â  Â  Â  Â  const resp = await fetch(`${backendUrl}/api/gifts/buy`, {
Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
Â  Â  Â  Â  Â  body: JSON.stringify({ girlId, giftType: type })
Â  Â  Â  Â  });
Â  Â  Â  Â  const data = await resp.json();

Â  Â  Â  Â  if (!resp.ok){
Â  Â  Â  Â  Â  alert(data?.error || 'Payment failed');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  appendMessage(`You sent ${label} ğŸ’`, 'user');
Â  Â  Â  Â  refreshEntitlements();
Â  Â  Â  }catch(err){
Â  Â  Â  Â  console.error("Gift purchase failed:", err);
Â  Â  Â  Â  alert('Payment failed');
Â  Â  Â  }
Â  Â  });

Â  Â  // send photo gating + upload
Â  Â  const photoBtn = document.getElementById('sendPhotoBtn');
Â  Â  const photoInput = document.getElementById('photoInput');

Â  Â  photoBtn.addEventListener('click', ()=>{
Â  Â  Â  if (!ENTITLEMENTS.canSendImages){
Â  Â  Â  Â  appendPersistentNotice(
Â  Â  Â  Â  Â  "Sending photos is a Premium feature. Upgrade using the pink button at the bottom to unlock it."
Â  Â  Â  Â  );
Â  Â  Â  Â  showCTA();
Â  Â  Â  Â  recordPremiumBlock();
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  photoInput.click();
Â  Â  });

Â  Â  photoInput.addEventListener('change', async ()=>{
Â  Â  Â  const file = photoInput.files && photoInput.files[0];
Â  Â  Â  if (!file) return;

Â  Â  Â  try {
Â  Â  Â  Â  const fd = new FormData();
Â  Â  Â  Â  fd.append("girlId", String(girlId));
Â  Â  Â  Â  fd.append("image", file);

Â  Â  Â  Â  const resp = await fetch(`${backendUrl}/api/photos/send`, {
Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  headers: { "Authorization": `Bearer ${token}` },
Â  Â  Â  Â  Â  body: fd
Â  Â  Â  Â  });
Â  Â  Â  Â  const data = await resp.json();
Â  Â  Â  Â  if (data?.ok && data?.url) {
Â  Â  Â  Â  Â  appendMessage(`IMAGE:${data.url}`, 'user');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  appendPersistentNotice("Photo upload failed. Please try again.");
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Photo send failed:", e);
Â  Â  Â  Â  appendPersistentNotice("Photo upload failed. Please try again.");
Â  Â  Â  } finally {
Â  Â  Â  Â  photoInput.value = "";
Â  Â  Â  }
Â  Â  });

Â  Â  // promo modal logic
Â  Â  function showStep(id){
Â  Â  Â  const ids = ['promoStepIntro','promoQ1','promoQ2','promoQ3','promoQ4','promoStepLoading','promoStepDone'];
Â  Â  Â  ids.forEach(x => { const el = document.getElementById(x); if (el) el.style.display = 'none'; });
Â  Â  Â  const tgt = document.getElementById(id); if (tgt) tgt.style.display = '';
Â  Â  }
Â  Â  function openPromoIntro(){
Â  Â  Â  if (PROMO_SHOWN) return;
Â  Â  Â  PROMO_SHOWN = true;
Â  Â  Â  const backdrop = document.getElementById('promoBackdrop');
Â  Â  Â  showStep('promoStepIntro');
Â  Â  Â  backdrop.style.display = 'flex';
Â  Â  Â  backdrop.setAttribute('aria-hidden','false');
Â  Â  }
Â  Â  (function wirePromo(){
Â  Â  Â  const backdrop = document.getElementById('promoBackdrop');
Â  Â  Â  const btnStart = document.getElementById('promoStart');
Â  Â  Â  const progressEl = document.getElementById('promoProgress');

Â  Â  Â  btnStart?.addEventListener('click', ()=>{ showStep('promoQ1'); });

Â  Â  Â  function wireAutoAdvance(stepId, inputName, nextStepId){
Â  Â  Â  Â  const step = document.getElementById(stepId);
Â  Â  Â  Â  if (!step) return;
Â  Â  Â  Â  step.addEventListener('change', (e)=>{
Â  Â  Â  Â  Â  const inp = e.target;
Â  Â  Â  Â  Â  if (inp && inp.name === inputName){
Â  Â  Â  Â  Â  Â  setTimeout(()=>{ if (nextStepId) showStep(nextStepId); }, 120);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  wireAutoAdvance('promoQ1', 'q_gender', 'promoQ2');
Â  Â  Â  wireAutoAdvance('promoQ2', 'q_over40', 'promoQ3');
Â  Â  Â  wireAutoAdvance('promoQ3', 'q_job', 'promoQ4');

Â  Â  Â  (function wireLast(){
Â  Â  Â  Â  const step = document.getElementById('promoQ4');
Â  Â  Â  Â  if (!step) return;
Â  Â  Â  Â  step.addEventListener('change', (e)=>{
Â  Â  Â  Â  Â  const inp = e.target;
Â  Â  Â  Â  Â  if (inp && inp.name === 'q_goal'){
Â  Â  Â  Â  Â  Â  setTimeout(()=>{
Â  Â  Â  Â  Â  Â  Â  showStep('promoStepLoading');
Â  Â  Â  Â  Â  Â  Â  let elapsed = 0;
Â  Â  Â  Â  Â  Â  Â  progressEl.style.width = '0%';
Â  Â  Â  Â  Â  Â  Â  const total = 5000, tick = 100;
Â  Â  Â  Â  Â  Â  Â  const t = setInterval(()=>{
Â  Â  Â  Â  Â  Â  Â  Â  elapsed += tick;
Â  Â  Â  Â  Â  Â  Â  Â  progressEl.style.width = Math.min(100, Math.floor(elapsed/total*100)) + '%';
Â  Â  Â  Â  Â  Â  Â  Â  if (elapsed >= total){
Â  Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(t);
Â  Â  Â  Â  Â  Â  Â  Â  Â  showStep('promoStepDone');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  }, tick);
Â  Â  Â  Â  Â  Â  }, 120);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  })();

Â  Â  Â  backdrop.addEventListener('click', (e)=>{
Â  Â  Â  Â  if (e.target === backdrop){
Â  Â  Â  Â  Â  const doneVisible = document.getElementById('promoStepDone').style.display !== 'none';
Â  Â  Â  Â  Â  if (doneVisible){
Â  Â  Â  Â  Â  Â  backdrop.style.display = 'none';
Â  Â  Â  Â  Â  Â  backdrop.setAttribute('aria-hidden','true');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  })();

Â  Â  // AI auto-picture drip (IDs 331..358)
Â  Â  let AI_DRIP_TIMER = null;
Â  Â  function startAiAutoDrip(){
Â  Â  Â  if (!Number.isInteger(girlId) || girlId < 331 || girlId > 358) return;
Â  Â  Â  if (AI_DRIP_TIMER) return;

Â  Â  Â  async function tick(){
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  if (TAKEOVER) return;
Â  Â  Â  Â  Â  await fetch(`${backendUrl}/api/ai/drip`, {
Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  "Authorization": `Bearer ${token}`,
Â  Â  Â  Â  Â  Â  Â  "Content-Type": "application/json"
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  body: JSON.stringify({ girlId })
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  console.warn("AI drip failed:", e);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  const baseMs = 12 * 60 * 1000;
Â  Â  Â  const jitter = () => Math.floor(Math.random()*120000) - 60000;
Â  Â  Â  AI_DRIP_TIMER = setInterval(tick, baseMs + jitter());
Â  Â  Â  window.addEventListener('beforeunload', ()=>{ if (AI_DRIP_TIMER) clearInterval(AI_DRIP_TIMER); });
Â  Â  }
    
    // BOOTSTRAP: Calls all initial setup functions
    (async function init(){
      await setHeader();
      await refreshEntitlements();
      ensureMessagesPolling();
      checkTakeover();
      loadMessages();
      startAiAutoDrip();
    })();
Â  </script>
</body>
</html>